<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Receitas</title>
</head>
<body>
    <div class="position-fixed bottom-0 end-0 p-1" style="margin-bottom: 55px; z-index: 1055;">
        <div id="loginToast" class="toast align-items-center text-bg-warning border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    Acesse sua conta para visualizar o modo de preparo!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
            </div>
        </div>
    </div>
      
    <h1 class="text-center my-4">Receitas mais populares</h1>
    <div id="receitas" class="container mx-auto row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4" style="max-width: 1200px;"></div>

    <div id="loading" class="text-center my-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>

    <div class="modal fade" id="preparoModal" tabindex="-1" aria-labelledby="preparoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="preparoModalLabel">Título da Receita</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body" id="preparoModalBody">
                    Modo de preparo aqui...
                </div>
            </div>
        </div>
    </div>

    

    <script>
        async function carregarReceitas() {
            document.getElementById('loading').style.display = 'block'; 
            const response = await fetch('/receitas');
            const receitas = await response.json();
            document.getElementById('loading').style.display = 'none';

            const container = document.getElementById('receitas');
            container.innerHTML = '';

            receitas.forEach((receita, index) => {
                const div = document.createElement('div');
                div.classList.add('col');

                div.innerHTML = `
                    <div class="card h-100">
                        ${receita.image_url ?
                            `<img src="${receita.image_url}" class="card-img-top img-fluid" style="height: 240px; object-fit: cover;" alt="${receita.title}">` :
                            `<div class="card-img-top" style="height: 200px; background-color: #f0f0f0;"></div>`
                        }
                        <div class="card-body">
                            <h5 class="card-title">${receita.title}</h5>
                            <p><strong>Ingredientes:</strong> ${receita.ingredients.map(i => i.name).join(', ')}</p>
                            <button class="btn btn-outline-primary btn-sm" type="button"
        onclick="verPreparoComVerificacao('${receita.title.replace(/'/g, "\\'")}', \`${receita.description.replace(/`/g, '\\`')}\`)">
    Ver preparo
</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

    function abrirModal(titulo, descricao) {
    const modalTitle = document.getElementById('preparoModalLabel');
    const modalBody = document.getElementById('preparoModalBody');

    modalTitle.textContent = titulo;

    // Divide o texto em frases por ponto final e cria uma lista ordenada
    const passos = descricao
        .split(/\.\s+/) // Divide após ponto final + espaço
        .filter(p => p.trim() !== '') // Remove strings vazias
        .map(p => `<li>${p.trim()}.</li>`) // Adiciona o ponto de volta no final
        .join('');

    modalBody.innerHTML = `<ol>${passos}</ol>`;

    const modal = new bootstrap.Modal(document.getElementById('preparoModal'));
    modal.show();
}

function mostrarToastLoginObrigatorio() {
    const toastEl = document.getElementById('loginToast');
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
}

async function verPreparoComVerificacao(titulo, descricao) {
    try {
        const response = await fetch('/auth/status', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        const data = await response.json();

        if (data.is_authenticated) {
            abrirModal(titulo, descricao);
        } else {
            mostrarToastLoginObrigatorio();
        }
    } catch (error) {
        console.error('Erro ao verificar autenticação:', error);
        mostrarToastLoginObrigatorio();
    }
}
        carregarReceitas();
    </script>

    <!-- Adicionando o link para o Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>